<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PAIX äºˆç´„ãƒšãƒ¼ã‚¸</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
    html { font-size: 16px; -webkit-text-size-adjust: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Hiragino Sans', 'Noto Sans JP', sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; color: #333; line-height: 1.5; }
    header { background-color: #2C2C2C; padding: 1rem; text-align: center; border-bottom: 3px solid #B8956A; position: sticky; top: 0; z-index: 100; }
    header h1 { margin: 0; font-size: 1.3rem; font-weight: 500; color: #FFFFFF; }
    .menu-section, .calendar-section, .customer-section { background: #FFFFFF; padding: 1rem; margin-bottom: 0.5rem; }
    .menu-section h2, .calendar-section h2, .customer-section h2 { font-size: 1.1rem; margin-bottom: 0.75rem; color: #333; }
    .form-group { margin-bottom: 1rem; }
    label { font-weight: 600; display: block; margin-bottom: 0.5rem; color: #333; font-size: 0.95rem; }
    select, input { width: 100%; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #FAFAFA; color: #333; font-size: 1rem; -webkit-appearance: none; appearance: none; }
    select { background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 12 12'%3E%3Cpath d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 0.75rem; padding-right: 2.5rem; }
    h3 { color: #555; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.9rem; line-height: 1.5; }
    .total-duration { font-size: 1.1rem; color: #B8956A; font-weight: bold; margin: 0.5rem 0; }
    .week-navigation { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; gap: 0.5rem; }
    .nav-button { background: linear-gradient(135deg, #B8956A 0%, #A68B5B 100%); border: none; color: #FFFFFF; font-size: 0.9rem; font-weight: 600; cursor: pointer; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.3s ease; min-width: 110px; }
    .nav-button:hover:not(:disabled) { background: linear-gradient(135deg, #A68B5B 0%, #957A4A 100%); transform: translateY(-2px); }
    .nav-button:disabled { opacity: 0.4; cursor: not-allowed; background: #E0E0E0; color: #999; }
    .current-month { font-size: 1.1rem; font-weight: 600; color: #333; text-align: center; flex: 1; }
    .schedule-wrapper { overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; max-height: 450px; border: 2px solid #B8956A; border-radius: 8px; background-color: #FFFFFF; }
    .schedule-wrapper::-webkit-scrollbar { width: 8px; }
    .schedule-wrapper::-webkit-scrollbar-track { background: #F5F5F5; border-radius: 4px; }
    .schedule-wrapper::-webkit-scrollbar-thumb { background: #B8956A; border-radius: 4px; }
    .schedule-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .schedule-table th, .schedule-table td { border: 1px solid #e0e0e0; text-align: center; padding: 0.5rem 0.2rem; }
    .schedule-table thead th { background-color: #FAFAFA; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #B8956A; }
    .schedule-table thead th:first-child { position: sticky; left: 0; top: 0; z-index: 20; background-color: #FFFFFF; min-width: 60px; border-right: 2px solid #B8956A; }
    .date-header { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
    .date-number { font-size: 1.2rem; font-weight: bold; }
    .date-day { font-size: 0.85rem; font-weight: normal; }
    .date-day.sunday { color: #777777; }
    .date-day.saturday { color: #3498DB; }
    .time-cell { background-color: #FAFAFA; font-size: 0.9rem; font-weight: 500; color: #666; position: sticky; left: 0; z-index: 5; min-width: 60px; border-right: 2px solid #B8956A; }
    .slot-cell { cursor: pointer; transition: background-color 0.2s ease; padding: 0; height: 45px; }
    .slot-cell.available { background-color: #FFFFFF; }
    .slot-cell.available:hover { background-color: #FFF5F8; }
    .slot-cell.unavailable { background-color: #F5F5F5; cursor: not-allowed; }
    .slot-cell.selected { background-color: #B8956A; }
    .slot-icon { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; }
    .slot-icon.available-icon { color: #B8956A; }
    .slot-icon.unavailable-icon { color: #CCC; }
    .slot-icon.selected-icon { color: #FFFFFF; }
    .required { color: #777777; margin-left: 0.25rem; }
    .reserve-button { width: calc(100% - 2rem); margin: 1rem; padding: 1rem; background-color: #B8956A; color: #FFFFFF; border: none; border-radius: 0.5rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; position: fixed; bottom: 0; left: 0; right: 0; z-index: 99; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .reserve-button:hover:not(:disabled) { background-color: #A68B5B; }
    .reserve-button:disabled { background-color: #CCC; cursor: not-allowed; }
    .button-spacer { height: 80px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto; }
    .modal-content { background-color: #FFFFFF; margin: 10% auto; padding: 1.5rem; width: 90%; max-width: 500px; border-radius: 0.75rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); }
    .modal-header { margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #B8956A; }
    .modal-header h2 { margin: 0; color: #333; font-size: 1.3rem; }
    .confirmation-details p { margin: 0.75rem 0; font-size: 1rem; line-height: 1.6; }
    .confirmation-details ul { margin: 0.5rem 0 0.5rem 1.5rem; padding: 0; }
    .confirmation-details li { margin: 0.5rem 0; }
    .shaving-notice { color: #777777; font-weight: bold; margin-top: 1rem; padding: 1rem; background-color: #F5F5F5; border-radius: 0.5rem; }
    .modal-buttons { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
    .modal-buttons button { flex: 1; padding: 0.875rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .cancel-button { background-color: #999; color: #FFFFFF; }
    .cancel-button:hover { background-color: #777; }
    .confirm-button { background-color: #B8956A; color: #FFFFFF; }
    .confirm-button:hover { background-color: #A68B5B; }
    .complete-message { text-align: center; padding: 2rem 0; }
    .return-button { display: block; width: 200px; margin: 1.5rem auto 0; padding: 0.875rem; background-color: #B8956A; color: #FFFFFF; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .calendar-button { padding: 0.875rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; color: #FFFFFF; display: none; background-color: #3498DB; }
    #completionDetails { text-align: left; background-color: #f9f9f9; padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
    #completionDetails p { margin: 0.5rem 0; line-height: 1.8; }
    #completionDetails strong { display: inline-block; min-width: 100px; color: #555; }
    #completionDetails ul { margin: 0.5rem 0 0.5rem 1.5rem; padding: 0; }
    #loadingOverlay { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); }
    .spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 48px; height: 48px; border: 5px solid #f3f3f3; border-top: 5px solid #B8956A; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    .loading-text { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); color: #FFFFFF; font-size: 1rem; font-weight: bold; }
    .message { padding: 1rem; margin: 1rem; border-radius: 0.5rem; text-align: center; }
    .message.error { background-color: #FFEBEE; color: #C62828; }
    @media screen and (max-width: 480px) {
      html { font-size: 14px; }
      header h1 { font-size: 1.1rem; }
      .nav-button { padding: 0.4rem 0.5rem; font-size: 0.85rem; min-width: 70px; }
      .current-month { font-size: 0.9rem; }
      .time-cell, .schedule-table thead th:first-child { min-width: 38px; font-size: 0.8rem; }
      .date-number { font-size: 1rem; }
      .date-day { font-size: 0.75rem; }
      .slot-cell { height: 35px; }
      .slot-icon { font-size: 1.3rem; }
      .modal-content { width: 95%; padding: 1rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>PAIXäºˆç´„ãƒšãƒ¼ã‚¸</h1>
  </header>

  <div class="menu-section">
    <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ</h2>
    <div id="menuCategories"></div>
    <div class="total-duration">åˆè¨ˆæ™‚é–“: <span id="totalDuration">0åˆ†</span></div>
  </div>

  <div class="calendar-section" id="calendarSection" style="display:none;">
    <div class="week-navigation">
      <button class="nav-button" id="prevWeekBtn" onclick="changeWeek(-1)">â—€ å‰ã®é€±</button>
      <div class="current-month" id="currentMonth"></div>
      <button class="nav-button" id="nextWeekBtn" onclick="changeWeek(1)">æ¬¡ã®é€± â–¶</button>
    </div>
    <div class="schedule-wrapper">
      <table class="schedule-table" id="scheduleTable">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <p style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 0.5rem;">â†•ï¸ ä¸Šä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
  </div>

  <div class="customer-section">
    <h2>ãŠå®¢æ§˜æƒ…å ±</h2>
    <div class="form-group">
      <label for="customerName">ãŠåå‰<span class="required">*</span></label>
      <input type="text" id="customerName" placeholder="å±±ç”°å¤ªéƒ" required>
    </div>
    <div class="form-group">
      <label for="phone">é›»è©±ç•ªå·<span class="required">*</span></label>
      <input type="tel" id="phone" placeholder="090-1234-5678" required>
    </div>
    <div class="form-group">
      <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
      <input type="email" id="email" placeholder="example@example.com">
    </div>
  </div>

  <div class="button-spacer"></div>
  <button class="reserve-button" id="reserveButton" onclick="reserve()" disabled>äºˆç´„ã™ã‚‹</button>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">å‡¦ç†ä¸­...</div>
  </div>

  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>äºˆç´„å†…å®¹ã®ç¢ºèª</h2></div>
      <div id="confirmationDetails" class="confirmation-details"></div>
      <div class="modal-buttons">
        <button class="cancel-button" onclick="closeConfirmationModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="confirm-button" onclick="confirmReservation()">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="completionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>äºˆç´„å®Œäº†</h2></div>
      <div class="complete-message">
        <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 1.5rem;">ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</p>
        <div id="completionDetails"></div>
        <button class="calendar-button" onclick="addToCalendar()" style="width: 100%; margin-bottom: 0.75rem;">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ </button>
        <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">å½“æ—¥ã®ã”æ¥åº—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™</p>
      </div>
      <button class="return-button" onclick="returnToReservationPage()">äºˆç´„ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
    </div>
  </div>

  <script>
    // ============================================
    // ğŸ“Œ è¨­å®š - GitHub Pagesç”¨ã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
    // ============================================
    const CONFIG = {
      // ğŸ“Œ Google Apps Script Web App URLï¼ˆè¨­å®šæ¸ˆã¿ï¼‰
      API_URL: 'https://script.google.com/macros/s/AKfycbxeneCCLqCgEAupeYFGrTpYO6a8mBQ0tF_oikGRAT0pl0-0XneCbR2-O3NJ_4Jmf2ExSw/exec',
      
      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ï¼‰
      CLIENT_ID: 'client_' + Math.random().toString(36).substr(2, 9)
    };

    // ============================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ============================================
    let selectedCourses = [];
    let weeklyAvailabilityData = null;
    let currentWeekOffset = 0;
    let selectedSlot = null;

    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      loadMenuCategories();
      setupEventListeners();
    });

    function setupEventListeners() {
      const phoneInput = document.getElementById('phone');
      phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^\d]/g, '');
        let formatted = '';
        if (value.length > 0) {
          if (value.startsWith('090') || value.startsWith('080') || value.startsWith('070')) {
            if (value.length <= 3) formatted = value;
            else if (value.length <= 7) formatted = value.slice(0, 3) + '-' + value.slice(3);
            else formatted = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
          } else if (value.startsWith('03') || value.startsWith('04') || value.startsWith('06')) {
            if (value.length <= 2) formatted = value;
            else if (value.length <= 6) formatted = value.slice(0, 2) + '-' + value.slice(2);
            else formatted = value.slice(0, 2) + '-' + value.slice(2, 6) + '-' + value.slice(6, 10);
          } else if (value.startsWith('0')) {
            if (value.length <= 3) formatted = value;
            else if (value.length <= 6) formatted = value.slice(0, 3) + '-' + value.slice(3);
            else if (value.length <= 8) formatted = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6);
            else formatted = value.slice(0, 4) + '-' + value.slice(4, 6) + '-' + value.slice(6, 10);
          } else formatted = value;
        }
        e.target.value = formatted;
      });

      window.onclick = (event) => {
        if (event.target.className === "modal") event.target.style.display = "none";
      };
    }

    // ============================================
    // APIå‘¼ã³å‡ºã—ï¼ˆfetchä½¿ç”¨ï¼‰
    // ============================================
    async function callApi(action, params = {}) {
      const url = new URL(CONFIG.API_URL);
      url.searchParams.append('action', action);
      url.searchParams.append('clientId', CONFIG.CLIENT_ID);
      
      for (const [key, value] of Object.entries(params)) {
        url.searchParams.append(key, value);
      }

      try {
        const response = await fetch(url.toString(), {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        throw error;
      }
    }

    async function postApi(action, data) {
      try {
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: action,
            clientId: CONFIG.CLIENT_ID,
            ...data
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API POST failed:', error);
        throw error;
      }
    }

    // ============================================
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    // ============================================
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // ============================================
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿
    // ============================================
    async function loadMenuCategories() {
      showLoading();
      try {
        const categories = await callApi('getMenus');
        if (categories.error) {
          throw new Error(categories.error);
        }
        displayMenuCategories(categories);
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    }

    function displayMenuCategories(categories) {
      const container = document.getElementById("menuCategories");
      container.innerHTML = Object.entries(categories).map(([category, menus]) => {
        const categoryTitle = {
          'è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼': '<h3>è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>',
          'å„ãƒ‘ãƒ¼ãƒ„è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼': '<h3>å„ãƒ‘ãƒ¼ãƒ„è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼<br>-S/M/Lãƒ‘ãƒ¼ãƒ„ã«ã¤ã„ã¦ã®è©³ç´°-<br>Sãƒ‘ãƒ¼ãƒ„ [é¼»ä¸‹/ä¸¡é ¬/ã‚¢ã‚´/æ‰‹æŒ‡ãƒ»ç”²/è¶³æŒ‡ãƒ»ç”²/ã†ãªã˜/ä¸¡è„‡/ä¹³è¼ª]<br>Mãƒ‘ãƒ¼ãƒ„ [ãƒ’ã‚¸ä¸Š/ãƒ’ã‚¸ä¸‹/ãƒ’ã‚¶ä¸Š/ãƒ’ã‚¶ä¸‹/Vãƒ©ã‚¤ãƒ³/Iãƒ©ã‚¤ãƒ³/Oãƒ©ã‚¤ãƒ³/ãŠå°»]<br>Lãƒ‘ãƒ¼ãƒ„ [è…•å…¨ä½“(è„‡è¾¼ã¿)/è¶³å…¨ä½“(ãŠå°»è¾¼ã¿)/èƒŒä¸­/èƒ¸.è…¹]</h3>',
          'ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°': '<h3>ã‚»ãƒ«ãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°</h3>'
        }[category] || '';

        const options = menus.map(menu => 
          `<option value='${JSON.stringify(menu)}'>${menu.name} (Â¥${menu.price.toLocaleString()} / ${menu.duration}åˆ†)</option>`
        ).join('');

        return `
          ${categoryTitle}
          <select onchange="handleMenuSelection(this, '${category}')" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${options}
          </select>
        `;
      }).join('');
    }

    function handleMenuSelection(select, category) {
      const selectedValue = select.value;
      selectedCourses = selectedCourses.filter(course => course.category !== category);
      
      if (selectedValue) {
        try {
          selectedCourses.push({ ...JSON.parse(selectedValue), category });
        } catch (error) {
          handleError('ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          select.value = "";
          return;
        }
      }
      calculateTotalDuration();
    }

    function calculateTotalDuration() {
      const totalDuration = selectedCourses.reduce((sum, course) => sum + course.duration, 0);
      document.getElementById("totalDuration").textContent = `${totalDuration}åˆ†`;
      
      if (totalDuration > 0) {
        loadWeeklyAvailability(totalDuration);
      } else {
        document.getElementById('calendarSection').style.display = 'none';
        weeklyAvailabilityData = null;
        selectedSlot = null;
        updateReserveButton();
      }
    }

    // ============================================
    // é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    // ============================================
    async function loadWeeklyAvailability(totalDuration) {
      showLoading();
      try {
        const data = await callApi('getWeeklyAvailability', { duration: totalDuration });
        if (data.error) {
          throw new Error(data.error);
        }
        weeklyAvailabilityData = data;
        currentWeekOffset = 0;
        selectedSlot = null;
        renderWeeklyCalendar();
        document.getElementById('calendarSection').style.display = 'block';
        updateReserveButton();
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    }

    function renderWeeklyCalendar() {
      if (!weeklyAvailabilityData) return;

      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() + (currentWeekOffset * 7));

      const weekDates = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        weekDates.push(date);
      }

      const firstDate = weekDates[0];
      const lastDate = weekDates[6];
      const monthText = firstDate.getMonth() === lastDate.getMonth()
        ? `${firstDate.getFullYear()}å¹´${firstDate.getMonth() + 1}æœˆ`
        : `${firstDate.getFullYear()}å¹´${firstDate.getMonth() + 1}æœˆ - ${lastDate.getMonth() + 1}æœˆ`;
      document.getElementById('currentMonth').textContent = monthText;

      document.getElementById('prevWeekBtn').disabled = currentWeekOffset === 0;
      document.getElementById('nextWeekBtn').disabled = currentWeekOffset >= 3;

      renderTableHeader(weekDates);
      renderTableBody(weekDates);
    }

    function renderTableHeader(weekDates) {
      const header = document.getElementById('tableHeader');
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      
      let headerHtml = '<tr><th></th>';
      weekDates.forEach(date => {
        const dayOfWeek = date.getDay();
        const dayName = dayNames[dayOfWeek];
        const dayClass = dayOfWeek === 0 ? 'sunday' : (dayOfWeek === 6 ? 'saturday' : '');
        
        headerHtml += `
          <th>
            <div class="date-header">
              <div class="date-number">${date.getDate()}</div>
              <div class="date-day ${dayClass}">${dayName}</div>
            </div>
          </th>
        `;
      });
      headerHtml += '</tr>';
      header.innerHTML = headerHtml;
    }

    function renderTableBody(weekDates) {
      const tbody = document.getElementById('tableBody');
      const timeSlots = weeklyAvailabilityData.timeSlots;
      
      let bodyHtml = '';
      timeSlots.forEach(timeSlot => {
        bodyHtml += `<tr><td class="time-cell">${timeSlot}</td>`;
        
        weekDates.forEach(date => {
          const dateKey = formatDateKey(date);
          const dayData = weeklyAvailabilityData.weeklyData[dateKey];
          const isAvailable = dayData && dayData[timeSlot];
          const isSelected = selectedSlot && selectedSlot.date === dateKey && selectedSlot.time === timeSlot;
          
          const cellClass = isSelected ? 'selected' : (isAvailable ? 'available' : 'unavailable');
          const iconClass = isSelected ? 'selected-icon' : (isAvailable ? 'available-icon' : 'unavailable-icon');
          const icon = isSelected ? 'â—' : (isAvailable ? 'ã€‡' : 'Ã—');
          const onclick = isAvailable ? `selectSlot('${dateKey}', '${timeSlot}')` : '';
          
          bodyHtml += `
            <td class="slot-cell ${cellClass}" ${onclick ? `onclick="${onclick}"` : ''}>
              <div class="slot-icon ${iconClass}">${icon}</div>
            </td>
          `;
        });
        
        bodyHtml += '</tr>';
      });
      
      tbody.innerHTML = bodyHtml;
    }

    function formatDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function changeWeek(offset) {
      currentWeekOffset += offset;
      if (currentWeekOffset < 0) currentWeekOffset = 0;
      if (currentWeekOffset > 3) currentWeekOffset = 3;
      selectedSlot = null;
      renderWeeklyCalendar();
      updateReserveButton();
    }

    function selectSlot(dateKey, timeSlot) {
      selectedSlot = { date: dateKey, time: timeSlot };
      renderWeeklyCalendar();
      updateReserveButton();
    }

    function updateReserveButton() {
      const button = document.getElementById('reserveButton');
      button.disabled = !(selectedCourses.length > 0 && selectedSlot !== null);
    }

    // ============================================
    // äºˆç´„å‡¦ç†
    // ============================================
    function validateForm() {
      const customerName = document.getElementById("customerName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      
      if (!customerName) { alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return false; }
      if (!phone) { alert("é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return false; }
      if (!selectedCourses.length) { alert("ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }
      if (!selectedSlot) { alert("æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }
      return true;
    }

    let isProcessingReservation = false;

    function reserve() {
      if (isProcessingReservation) return;
      if (!validateForm()) return;
      
      isProcessingReservation = true;
      const reserveButton = document.getElementById('reserveButton');
      reserveButton.disabled = true;

      const customerName = document.getElementById("customerName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();

      const hasHairRemoval = selectedCourses.some(course =>
        course.category === 'è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼' || course.category === 'å„ãƒ‘ãƒ¼ãƒ„è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼'
      );

      const selectedDateTime = `${selectedSlot.date.replace(/-/g, '/')} ${selectedSlot.time}`;

      const details = document.getElementById("confirmationDetails");
      details.innerHTML = `
        <p><strong>ãŠåå‰:</strong> ${customerName}</p>
        <p><strong>é›»è©±ç•ªå·:</strong> ${phone}</p>
        <p><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${email || 'æœªå…¥åŠ›'}</p>
        <p><strong>äºˆç´„æ—¥æ™‚:</strong> ${selectedDateTime}</p>
        <p><strong>é¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹:</strong></p>
        <ul>${selectedCourses.map(course => `<li>${course.name} (${course.duration}åˆ†)</li>`).join('')}</ul>
        <p><strong>åˆè¨ˆæ™‚é–“:</strong> ${document.getElementById("totalDuration").textContent}</p>
        ${hasHairRemoval ? '<div class="shaving-notice">â€» æ–½è¡“å‰ã«ã€ã”è‡ªèº«ã§å±Šãç¯„å›²ã®è„±æ¯›éƒ¨åˆ†ã®ã‚·ã‚§ãƒ¼ãƒ“ãƒ³ã‚°ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</div>' : ''}
      `;
      document.getElementById("confirmationModal").style.display = "block";

      setTimeout(() => {
        isProcessingReservation = false;
        reserveButton.disabled = false;
      }, 1000);
    }

    function closeConfirmationModal() {
      document.getElementById("confirmationModal").style.display = "none";
    }

    async function confirmReservation() {
      const customerName = document.getElementById("customerName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const selectedDateTime = `${selectedSlot.date} ${selectedSlot.time}:00`;

      document.getElementById("confirmationModal").style.display = "none";
      showLoading();

      try {
        const result = await postApi('createReservation', {
          selectedCourses: selectedCourses,
          selectedDateTime: selectedDateTime,
          customerName: customerName,
          phone: phone,
          email: email
        });

        if (result.error) {
          throw new Error(result.error);
        }

        displayCompletionDetails();
        document.getElementById("completionModal").style.display = "block";
      } catch (error) {
        alert(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãŠæ‰‹æ•°ã§ã™ãŒãŠé›»è©±ã§ã”äºˆç´„ãã ã•ã„ã€‚');
      } finally {
        hideLoading();
      }
    }

    function displayCompletionDetails() {
      const details = document.getElementById("completionDetails");
      const [year, month, day] = selectedSlot.date.split('-');
      const date = new Date(selectedSlot.date);
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dayOfWeek = dayNames[date.getDay()];
      
      const hasHairRemoval = selectedCourses.some(course =>
        course.category === 'è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼' || course.category === 'å„ãƒ‘ãƒ¼ãƒ„è„±æ¯›ãƒ¡ãƒ‹ãƒ¥ãƒ¼'
      );
      
      const shavingNotice = hasHairRemoval 
        ? '<p style="color: #777777; font-weight: bold; margin-top: 1rem; padding: 0.75rem; background-color: #F5F5F5; border-radius: 0.375rem; font-size: 0.9rem;">â€» æ–½è¡“å‰ã«ã€ã”è‡ªèº«ã§å±Šãç¯„å›²ã®è„±æ¯›éƒ¨åˆ†ã®ã‚·ã‚§ãƒ¼ãƒ“ãƒ³ã‚°ã‚’ãŠé¡˜ã„ã—ã¾ã™</p>'
        : '';
      
      details.innerHTML = `
        <p><strong>äºˆç´„æ—¥æ™‚:</strong><br>${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥ï¼ˆ${dayOfWeek}ï¼‰${selectedSlot.time}</p>
        <p><strong>é¸æŠã‚³ãƒ¼ã‚¹:</strong></p>
        <ul>${selectedCourses.map(course => `<li>${course.name}<br><span style="font-size: 0.9rem; color: #666;">${course.duration}åˆ† / Â¥${course.price.toLocaleString()}</span></li>`).join('')}</ul>
        <p><strong>åˆè¨ˆæ™‚é–“:</strong> ${selectedCourses.reduce((sum, course) => sum + course.duration, 0)}åˆ†</p>
        <p><strong>åˆè¨ˆé‡‘é¡:</strong> Â¥${selectedCourses.reduce((sum, course) => sum + course.price, 0).toLocaleString()}</p>
        ${shavingNotice}
      `;
      
      const calendarButton = document.querySelector('.calendar-button');
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (calendarButton) calendarButton.style.display = isSafari ? 'block' : 'none';
    }

    // ============================================
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¿½åŠ 
    // ============================================
    function addToCalendar() {
      const [year, month, day] = selectedSlot.date.split('-');
      const [hour, minute] = selectedSlot.time.split(':');
      const totalDuration = selectedCourses.reduce((sum, course) => sum + course.duration, 0);
      const totalPrice = selectedCourses.reduce((sum, course) => sum + course.price, 0);
      const customerName = document.getElementById("customerName").value.trim();
      
      const startDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute));
      const endDate = new Date(startDate.getTime() + totalDuration * 60 * 1000);
      
      const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      if (isIOS) {
        addToAppleCalendar(startDate, endDate, customerName, selectedCourses, totalDuration, totalPrice);
      } else if (isAndroid) {
        addToGoogleCalendar(startDate, endDate, customerName, selectedCourses, totalDuration, totalPrice);
      } else {
        addToGoogleCalendar(startDate, endDate, customerName, selectedCourses, totalDuration, totalPrice);
      }
    }

    function addToAppleCalendar(startDate, endDate, customerName, courses, totalDuration, totalPrice) {
      const formatICSDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}${m}${d}T${h}${min}00`;
      };
      
      const now = new Date();
      const timestamp = formatICSDate(now);
      const uid = `${timestamp}-${Math.random().toString(36).substr(2, 9)}@paix.reservation.com`;
      
      const courseDetails = courses.map((course, index) => 
        `${index + 1}. ${course.name} (${course.duration}åˆ† / Â¥${course.price.toLocaleString()})`
      ).join('\\n');
      
      const description = [
        'ã”äºˆç´„å†…å®¹:', '', courseDetails, '',
        `åˆè¨ˆæ™‚é–“: ${totalDuration}åˆ†`, `åˆè¨ˆé‡‘é¡: Â¥${totalPrice.toLocaleString()}`,
        '', '---', '', `ã‚¹ã‚¿ãƒƒãƒ•ä¸€åŒã€${customerName}æ§˜ã®ã”æ¥åº—ã‚’å¿ƒã‚ˆã‚ŠãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚`,
        '', 'PAIX', 'ã€’901-0221 æ²–ç¸„çœŒè±Šè¦‹åŸå¸‚åº§å®‰ï¼’ï¼ï¼˜âˆ’ï¼’ SOUTH ZA â…  304å·å®¤'
      ].join('\\n');
      
      const icsContent = [
        'BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//PAIX Reservation System//JP',
        'CALSCALE:GREGORIAN', 'METHOD:PUBLISH', 'X-WR-CALNAME:PAIX', 'X-WR-TIMEZONE:Asia/Tokyo',
        'BEGIN:VTIMEZONE', 'TZID:Asia/Tokyo', 'BEGIN:STANDARD', 'DTSTART:19700101T000000',
        'TZOFFSETFROM:+0900', 'TZOFFSETTO:+0900', 'TZNAME:JST', 'END:STANDARD', 'END:VTIMEZONE',
        'BEGIN:VEVENT', `UID:${uid}`, `DTSTAMP:${timestamp}`,
        `DTSTART;TZID=Asia/Tokyo:${formatICSDate(startDate)}`,
        `DTEND;TZID=Asia/Tokyo:${formatICSDate(endDate)}`,
        'SUMMARY:PAIXäºˆç´„', `DESCRIPTION:${description}`,
        'LOCATION:PAIXï¼ˆã€’901-0221 æ²–ç¸„çœŒè±Šè¦‹åŸå¸‚åº§å®‰ï¼’ï¼ï¼˜âˆ’ï¼’ SOUTH ZA â…  304å·å®¤ï¼‰',
        'STATUS:CONFIRMED', 'TRANSP:OPAQUE', 'SEQUENCE:0',
        'BEGIN:VALARM', 'TRIGGER:-PT60M', 'ACTION:DISPLAY', 'DESCRIPTION:PAIXã®ã”äºˆç´„1æ™‚é–“å‰ã§ã™', 'END:VALARM',
        'END:VEVENT', 'END:VCALENDAR'
      ].join('\r\n');
      
      const dataUri = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsContent);
      window.location.href = dataUri;
    }

    function addToGoogleCalendar(startDate, endDate, customerName, courses, totalDuration, totalPrice) {
      const formatGoogleDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}${m}${d}T${h}${min}00`;
      };
      
      const courseDetails = courses.map((course, index) => 
        `${index + 1}. ${course.name} (${course.duration}åˆ† / Â¥${course.price.toLocaleString()})`
      ).join('\n');
      
      const title = encodeURIComponent('PAIXäºˆç´„');
      const details = encodeURIComponent(`ã”äºˆç´„å†…å®¹:\n\n${courseDetails}\n\nåˆè¨ˆæ™‚é–“: ${totalDuration}åˆ†\nåˆè¨ˆé‡‘é¡: Â¥${totalPrice.toLocaleString()}\n\n---\n\nã‚¹ã‚¿ãƒƒãƒ•ä¸€åŒã€${customerName}æ§˜ã®ã”æ¥åº—ã‚’å¿ƒã‚ˆã‚ŠãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nPAIX\nã€’901-0221 æ²–ç¸„çœŒè±Šè¦‹åŸå¸‚åº§å®‰ï¼’ï¼ï¼˜âˆ’ï¼’ SOUTH ZA â…  304å·å®¤`);
      const location = encodeURIComponent('PAIXï¼ˆã€’901-0221 æ²–ç¸„çœŒè±Šè¦‹åŸå¸‚åº§å®‰ï¼’ï¼ï¼˜âˆ’ï¼’ SOUTH ZA â…  304å·å®¤ï¼‰');
      const dates = `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
      
      window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}&location=${location}`, '_blank');
    }

    function returnToReservationPage() {
      document.getElementById("customerName").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("email").value = "";
      selectedCourses = [];
      selectedSlot = null;
      weeklyAvailabilityData = null;
      currentWeekOffset = 0;

      document.querySelectorAll("#menuCategories select").forEach(select => select.value = "");
      document.getElementById("totalDuration").textContent = "0åˆ†";
      document.getElementById('calendarSection').style.display = 'none';
      document.getElementById("completionModal").style.display = "none";
      
      updateReserveButton();
    }

    function handleError(error) {
      console.error('Error:', error);
      hideLoading();
      
      const message = error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
      
      if (message.includes('Failed to fetch') || message.includes('NetworkError')) {
        alert('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } else {
        alert(message);
      }
    }
  </script>
</body>
</html>
